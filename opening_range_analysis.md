# Opening Range戦略の最適化結果

## 実行概要
- **実行日時**: 2025-12-18
- **トライアル数**: 20トライアル（5トライアル完了で中断）
- **データ期間**: Train/Valid/Test分割

## 最適化結果

### ステータス: **失敗**

全5トライアルでBest value: -10（ペナルティスコア）を記録し、有効なパラメータセットを見つけることができませんでした。

## 戦略の問題点

### 1. 初期実装の欠陥
**問題**: ブレイクアウト後、全てのデータポイントでエントリーし続ける

- 1日で19,647件の取引（ほぼ全データポイント）
- 総PnL: -37,248円
- 全てロングポジション（高値ブレイクのみ）

**原因**: 価格が`opening_high`を超えている全ての時点でエントリー条件が成立

### 2. 修正後の実装
**改善点**: ブレイクした「瞬間」のみエントリーするように修正

```python
# 上方ブレイク: 前回は範囲内 or 以下、今回は範囲より上
long_mask = (
    (after_range['prev_mid'] <= opening_high) &
    (after_range['mid'] > opening_high) &
    spread_ok
)
```

**結果（1日分テスト）**:
- 取引数: 42件（合理的な範囲）
- 総PnL: -10.25円
- ロング: 42件、ショート: 0件

**結果（Train期間全体、パラメータ: range_minutes=15, hold_time=120, max_spread=0.10）**:
- 総取引数: 8,288件
- 総PnL: **-4,490,466円** (約-450万円)
- Sharpe比率: **-9.06**
- 最大ドローダウン: **89.8%**
- 勝率: 37.6% (統計計算に問題がある可能性)

### 3. 最適化の失敗理由

最適化の目的関数は以下の条件でペナルティを与える:

```python
if train_stats['total_trades'] < 50:
    return -10  # 取引数不足
if train_stats['max_dd'] > 30:
    return -10  # ドローダウン超過 ← ここで失敗
```

**全トライアルでmax_dd > 30%の条件を満たせず、-10を返した**

## 戦略の根本的課題

### 1. ブレイクアウトの信頼性
- 高値ブレイク後、価格が戻ってしまうケースが多い
- 「だまし」のブレイクアウトが頻発
- hold_timeの間に利益を確保できない

### 2. 方向性の偏り
- テストした日（2023-12-18）では上昇トレンドのため、高値ブレイクのみ
- 安値ブレイクが発生せず、ショートポジションなし
- 一方向の取引に偏る可能性

### 3. ドローダウンの大きさ
- 89.8%のドローダウンは実用不可能
- 資本の約90%を失うリスク
- 目標値30%を大幅に超過

## 戦略改善の提案

### 短期的改善
1. **フィルターの追加**
   - ボラティリティ確認（高ボラ時のみエントリー）
   - 出来高確認（流動性が高い時のみ）
   - トレンド確認（長期移動平均との整合性）

2. **損切り・利確の実装**
   - ストップロス: レンジ幅の50%
   - テイクプロフィット: レンジ幅の100%

3. **タイムフィルター**
   - 市場オープン直後のボラティリティが落ち着くまで待つ
   - 10:00以降など

### 長期的改善
1. **複数日のレンジを考慮**
   - 前日のhigh/lowも参照
   - より確実なブレイクアウトレベルを設定

2. **機械学習による予測**
   - ブレイクアウトが成功するか失敗するかを予測
   - 過去のパターンから学習

3. **他の戦略との組み合わせ**
   - 単独では不安定なので、他の戦略とポートフォリオを組む
   - リスク分散

## 結論

### Opening Range戦略は現時点で「無効」

**理由**:
- 最大ドローダウンが89.8%（許容値30%を大幅超過）
- Sharpe比率-9.06（極めて悪い）
- 総損失450万円（Train期間）
- 全20トライアルで有効なパラメータセットが見つからず

### 推奨アクション
1. **戦略の大幅な改善が必要**（フィルター追加、損切り実装など）
2. **他の戦略を優先**（momentum_filter, volatility_regime, multi_timeframeなど）
3. **Opening Rangeは保留**し、他の有効な戦略に注力する

## テクニカル詳細

### テストしたパラメータ空間
```python
params = {
    'range_minutes': [5, 10, 15, 30],     # オープニングレンジの期間
    'hold_time': [60, 120, 300, 600],     # 保有時間（秒）
    'max_spread': [0.05, 0.06, ..., 0.10] # 最大許容スプレッド
}
```

### データ
- データ期間: 2023年12月〜
- Train/Valid/Test分割
- 1秒足データ
- QQQオプション（デルタ0.5近辺）

### コード修正
ファイル: `/mnt/c/Users/kaba/Desktop/ib/advanced_strategies.py`
- 行230-246: ブレイクアウトロジックを修正
- 「ブレイクした瞬間」のみエントリーする仕組みを実装
